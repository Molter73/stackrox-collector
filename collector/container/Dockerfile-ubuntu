FROM ubuntu:14.04
MAINTAINER StackRox

# SYSDIG_HOST_ROOT is required by the sysdig kernel module; used as a prefix to
# paths like /dev/sysdig0, /proc, and /boot. Make sure this matches the volume
# mount paths used when launching this container.
#
# COLLECTOR_CONFIG is the required json config string, and it defaults to
# { "syscalls": [],"topic_query_field": "" }
#
# MAX_CONTENT_LENGTH_KB is optional, and it defaults to 1024.
#
# CONNECTION_LIMIT is optional, and it defaults to 64.
#
# CONNECTION_LIMIT_PER_IP is optional, and it defaults to 64.
#
# CONNECTION_TIMEOUT is optional, and it defaults to 8.
#
# SERVER_ENDPOINT is optional (but highly recommended), and it defaults to roxd.stackrox:8888.
#
# MAP_REFRESH_INTERVAL_MS is optional, and it defaults to 1000.
ENV SYSDIG_HOST_ROOT=/host \
    MAX_CONTENT_LENGTH_KB=1024 \
    CONNECTION_LIMIT=64 \
    CONNECTION_LIMIT_PER_IP=64 \
    CONNECTION_TIMEOUT=8 \
    SERVER_ENDPOINT=roxd.stackrox:8888/v0.1/api/containers/topic_map \
    MAP_REFRESH_INTERVAL_MS=1000 \
    CHISEL='LS0gQ2hpc2VsIGRlc2NyaXB0aW9uCmRlc2NyaXB0aW9uID0gIm9ubHkgZGlzcGxheSBldmVudHMgcmVsZXZhbnQgdG8gc2VjdXJpdHkgbW9kZWxpbmcgYW5kIGRldGVjdGlvbiIKc2hvcnRfZGVzY3JpcHRpb24gPSAic2VjdXJpdHkgcmVsZXZhbnQiCmNhdGVnb3J5ID0gIm1pc2MiCgotLSBDaGlzZWwgYXJndW1lbnQgbGlzdAphcmdzID0ge30KCi0tIEV2ZW50IHBhcnNpbmcgY2FsbGJhY2sKZnVuY3Rpb24gb25fZXZlbnQoKQogICAgcmV0dXJuIHRydWUKZW5kCgpmdW5jdGlvbiBvbl9pbml0KCkKICAgIGlnbm9yZV9pbWFnZV9zb3VyY2VzID0gewogICAgICAgICd1cy5nY3IuaW8vdWx0cmEtY3VycmVudC04MjUvJywKICAgICAgICAnc3RhY2tyb3gvJywKICAgICAgICAnc3RhY2tyb3hkb2NrZXJodWIvJywKICAgIH0KICAgIGlnbm9yZV9pbWFnZV9uYW1lcyA9IHsKICAgICAgICAnL2VuZm9yY2VyJywKICAgICAgICAnL2V4dHJhY3RvcicsCiAgICAgICAgJy9nb2xhbmcnLAogICAgICAgICcvaW1hZ2Utc2Nhbm5lcicsCiAgICAgICAgJy9rYWZrYScsCiAgICAgICAgJy9rdWJlY3RsLXByb3h5JywKICAgICAgICAnL2xhYicsCiAgICAgICAgJy9sZWFybmVyJywKICAgICAgICAnL3Byb21ldGhldXMnLAogICAgICAgICcvcm94ZCcsCiAgICAgICAgJy9yb3hkYicsCiAgICAgICAgJy9yb3h1aScsCiAgICAgICAgJy90cmFuc2Zvcm1lcicsCiAgICAgICAgJy93aXphcmQnLAogICAgICAgICcvem9va2VlcGVyJywKICAgIH0KICAgIGt1YmVybmV0ZXNfc291cmNlID0gJ2djci5pby9nb29nbGVfY29udGFpbmVycy8nCgogICAgZmlsdGVyID0gIm5vdCBjb250YWluZXIuaWQgPSAnaG9zdCdcbiIKICAgIC0tYmVnaW4gc2V0IG9mICdjb250YWlucycgY2hlY2tzCiAgICBwcmVmaXggPSAiIGNvbnRhaW5lci5pbWFnZSBjb250YWlucyAnIgogICAgc3VmZml4ID0gIiciCiAgICBmaWx0ZXIgPSBmaWx0ZXIgLi4gImFuZCBub3QgKCIKICAgIC0tZ29hbDogYW5kIG5vdCAoIChjb250YWluZXIuaW1hZ2UgY29udGFpbnMgJ3N0YWNrcm94Lycgb3IgLi4uKSBhbmQgKGNvbnRhaW5lci5pbWFnZSBjb250YWlucyAncm94ZCcgb3IgLi4uKSApCiAgICBmaWx0ZXIgPSBmaWx0ZXIgLi4gIlxuICAoXG4gICAgIgogICAgZm9yIHNvdXJjZV9pbmRleCwgaW1hZ2Vfc291cmNlIGluIHBhaXJzKGlnbm9yZV9pbWFnZV9zb3VyY2VzKSBkbwogICAgICAgIGZpbHRlciA9IGZpbHRlciAuLiBwcmVmaXggLi4gaW1hZ2Vfc291cmNlIC4uIHN1ZmZpeAogICAgICAgIGlmIHNvdXJjZV9pbmRleCA8IHRhYmxlLmdldG4oaWdub3JlX2ltYWdlX3NvdXJjZXMpIHRoZW4KICAgICAgICAgICAgZmlsdGVyID0gZmlsdGVyIC4uICIgb3IgXG4gICAgIgogICAgICAgIGVuZAogICAgZW5kCiAgICBmaWx0ZXIgPSBmaWx0ZXIgLi4gIlxuICApIFxuICBhbmQgXG4gIChcbiAgICAiCiAgICBmb3IgbmFtZV9pbmRleCwgaW1hZ2VfbmFtZSBpbiBwYWlycyhpZ25vcmVfaW1hZ2VfbmFtZXMpIGRvCiAgICAgICAgZmlsdGVyID0gZmlsdGVyIC4uIHByZWZpeCAuLiBpbWFnZV9uYW1lIC4uIHN1ZmZpeAogICAgICAgIGlmIG5hbWVfaW5kZXggPCB0YWJsZS5nZXRuKGlnbm9yZV9pbWFnZV9uYW1lcykgdGhlbgogICAgICAgICAgICBmaWx0ZXIgPSBmaWx0ZXIgLi4gIiBvciBcbiAgICAiCiAgICAgICAgZW5kCiAgICBlbmQKICAgIGZpbHRlciA9IGZpbHRlciAuLiAiXG4gICkgIgogICAgLS1lbmQgc2V0IG9mICdjb250YWlucycgY2hlY2tzCiAgICBmaWx0ZXIgPSBmaWx0ZXIgLi4gIlxuKVxuIgogICAgLS1pZ25vcmUgc3dhcm0gY29udGFpbmVycwogICAgZmlsdGVyID0gZmlsdGVyIC4uICJhbmQgbm90IGNvbnRhaW5lci5pbWFnZSA9ICdzd2FybScgXG4iCiAgICAtLWlnbm9yZSBrdWJlcm5ldGVzIGNvbnRhaW5lcnMKICAgIGZpbHRlciA9IGZpbHRlciAuLiAiYW5kIG5vdCBjb250YWluZXIuaW1hZ2UgY29udGFpbnMgJyIgLi4ga3ViZXJuZXRlc19zb3VyY2UgLi4gIicgIgogICAgY2hpc2VsLnNldF9maWx0ZXIoZmlsdGVyKQogICAgcmV0dXJuIHRydWUKZW5kCg=='

# HTTP API port (4419)
EXPOSE 4419

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        build-essential \
        ca-certificates \
        gcc-4.8 \
        g++-4.8 \
        jq \
        libboost-regex-dev \
        libjsoncpp0 \
        libmicrohttpd10 \
        libssl1.0.0 \
        procps \
        debian-keyring \
        debian-archive-keyring \
    && apt-get clean \
    ;

# Update Debian signing keys, which are required to get old kernels from Jessie.
RUN cp /etc/apt/sources.list /etc/apt/sources.list.bak && \
  echo "deb http://ftp.us.debian.org/debian jessie main" > /etc/apt/sources.list && \
  apt-get update && \
  apt-get install -y debian-keyring debian-archive-keyring && \
  rm /etc/apt/sources.list && \
  mv /etc/apt/sources.list.bak /etc/apt/sources.list

COPY bin/curl /usr/local/bin/curl
COPY bin/collector /usr/local/bin/collector
COPY bin/sysdig /usr/bin/sysdig
COPY driver/sysdig-probe.ko /usr/bin/sysdig-probe.ko
COPY libs/librdkafka.so /usr/local/lib/librdkafka.so
COPY libs/libcurl.so /usr/local/lib/libcurl.so
COPY libs/libsysdignative.so /usr/local/lib/libsysdignative.so
COPY driver /driver

# `ldconfig` is required so that `curl` can find its `libcurl.so`.
RUN ldconfig

WORKDIR /

# update StackRox boot script
COPY scripts/bootstrap.sh /bootstrap.sh
RUN chown root.root /bootstrap.sh
RUN chmod 700 /bootstrap.sh

# copy notice and license files
COPY NOTICE.txt /NOTICE.txt
COPY COPYING-GPLv2.txt /COPYING-GPLv2.txt
COPY COPYING-LGPLv2.1.txt /COPYING-LGPLv2.1.txt

ENTRYPOINT ["/bootstrap.sh"]

# You must provide a BROKER_LIST environment variable or override the CMD.
# For information on other variables, see the explanations of these environment variables above.
CMD collector \
        --collector-config=$COLLECTOR_CONFIG \
        --chisel=$CHISEL \
        --broker-list=$BROKER_LIST \
        --max-content-length=$MAX_CONTENT_LENGTH_KB \
        --connection-limit=$CONNECTION_LIMIT \
        --per-ip-connection-limit=$CONNECTION_LIMIT_PER_IP \
        --connection-timeout=$CONNECTION_TIMEOUT \
        --server-endpoint=$SERVER_ENDPOINT \
        --map-refresh-interval=$MAP_REFRESH_INTERVAL_MS

